{% extends "base.html" %}

{% block title %}パスワード変更{% endblock %}

{% block styles %}
{{ super() }}
<!-- simple-keyboard CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
<style>
    /* キーボード全体のスタイル */
    .simple-keyboard {
        position: fixed; /* 画面下部に固定 */
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 800px; /* 最大幅 */
        background-color: #f0f0f0;
        border-top: 1px solid #ccc;
        border-radius: 8px 8px 0 0;
        padding: 10px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none; /* 初期状態では非表示 */
    }
    .simple-keyboard.show {
        display: block; /* 表示する */
    }
</style>
{% endblock %}

{% block content %}
    <h2>パスワード変更</h2>
    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}
    <form method="POST">
        <label for="new_password">新しいパスワード:</label>
        <input type="password" id="new_password" name="new_password" class="virtual-keyboard-input" required><br><br>
        
        <label for="confirm_password">新しいパスワード（確認）:</label>
        <input type="password" id="confirm_password" name="confirm_password" class="virtual-keyboard-input" required><br><br>
        
        <button type="submit">変更</button>
    </form>

    <!-- 仮想キーボードのコンテナ -->
    <div class="simple-keyboard"></div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- simple-keyboard JS -->
<script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>

<!-- 仮想キーボード用スクリプト -->
<script>
    window.addEventListener('load', () => {
        const Keyboard = window.SimpleKeyboard.default;
        const keyboard = new Keyboard('.simple-keyboard', {
            onChange: input => onChange(input),
            onKeyPress: button => onKeyPress(button),
            layout: {
                'default': [
                    '1 2 3 4 5 6 7 8 9 0',
                    'q w e r t y u i o p',
                    'a s d f g h j k l',
                    '{shift} z x c v b n m {backspace}',
                    '{space}'
                ],
                'shift': [
                    '! @ # $ % ^ & * ( )',
                    'Q W E R T Y U I O P',
                    'A S D F G H J K L',
                    '{shift} Z X C V B N M {backspace}',
                    '{space}'
                ]
            },
            display: {
                '{shift}': '⇧',
                '{backspace}': '⌫',
                '{space}': ' '
            }
        });

        const keyboardElement = document.querySelector('.simple-keyboard');
        let activeInput = null;

        document.querySelectorAll('.virtual-keyboard-input').forEach(input => {
            input.addEventListener('focus', (e) => {
                activeInput = e.target;
                keyboard.setInput(activeInput.value);
                keyboardElement.classList.add('show');
            });
        });

        function onChange(input) {
            if (activeInput) {
                activeInput.value = input;
            }
        }

        function onKeyPress(button) {
            if (button === '{shift}') {
                const currentLayout = keyboard.options.layoutName;
                const newLayout = currentLayout === 'default' ? 'shift' : 'default';
                keyboard.setOptions({ layoutName: newLayout });
            }
        }

        // キーボードの外側をクリックしたら非表示にする
        document.addEventListener('click', (e) => {
            if (!keyboardElement.contains(e.target) && !e.target.classList.contains('virtual-keyboard-input')) {
                keyboardElement.classList.remove('show');
                activeInput = null;
            }
        });
    });
</script>
{% endblock %}
