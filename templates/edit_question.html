<!-- templates/edit_question.html -->
{% extends "base.html" %}
{% block title %}問題編集{% endblock %}

{% block content %}
<h2>問題編集</h2>
<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type=number] {
      -webkit-appearance: none;
      appearance: none;
      -moz-appearance: textfield;
    }
    .sub-question, .function-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .sub-question > div {
      margin-bottom: 5px;
    }
    .sub-question label {
      font-weight: bold;
    }
    .function-entry {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .function-entry input {
        flex: 1;
    }
    .remove-function-entry {
        background: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
    }
</style>
<form method="post" action="{{ url_for('save_question', quest_id=quest_id, question_id=question.id if question else 'new') }}">
  <input type="hidden" name="title" value="{{ title }}">
  <input type="hidden" name="level" value="{{ level }}">
  <label>タイプ:</label>
  <select name="type" id="type-select">
    <option value="choice" {% if question and question.type == 'choice' %}selected{% endif %}>4択問題</option>
    <option value="multiple_choice" {% if question and question.type == 'multiple_choice' %}selected{% endif %}>複数選択</option>
    <option value="sort" {% if question and question.type == 'sort' %}selected{% endif %}>並び替え</option>
    <option value="numeric" {% if question and question.type == 'numeric' %}selected{% endif %}>数値入力</option>
    <option value="fill_in_the_blank_en" {% if question and question.type == 'fill_in_the_blank_en' %}selected{% endif %}>英語穴埋め</option>
    <option value="svg_interactive" {% if question and question.type == 'svg_interactive' %}selected{% endif %}>図形問題</option>
    <option value="function_graph" {% if question and question.type == 'function_graph' %}selected{% endif %}>方程式グラフ</option>
  </select>

  <label>問題文（Markdown）:</label>
  <textarea name="text" id="text-input" rows="4" cols="60">{{ question.text if question else '' }}</textarea>
  <div id="text-preview" class="markdown-preview" style="margin-bottom: 1rem;"></div>

  <label>解説（Markdown）:</label>
  <textarea name="explanation" id="explanation-input" rows="4" cols="60">{{ question.explanation or '' }}</textarea>
  <div id="explanation-preview" class="markdown-preview" style="margin-bottom: 1rem;"></div>

  <div id="choice-section" style="display:none;">
    <label>選択肢:</label><br>
    {% for i in range(4) %}
      <input type="text" name="choice{{ i }}" id="choice{{ i }}" value="{{ choices[i] if question and (question.type == 'choice' or question.type == 'multiple_choice') and question.choices|length > i else '' }}"><br>
      <div id="choice{{ i }}_preview" class="markdown-preview" style="margin-bottom: 0.5rem;"></div>
    {% endfor %}
    <label>正解:</label>
    <input type="text" name="answer" value="{{ question.answer if question and (question.type == 'choice' or question.type == 'multiple_choice') else '' }}" placeholder="単一選択は正解、複数選択はカンマ区切り（例: A,C）">
  </div>

  <div id="sort-section" style="display:none;">
    <label>正解の並び順（文字列）:</label>
    <input type="text" name="answer_sort" value="{% if question and question.type == 'sort' %}{{ question.answer or '' }}{% endif %}">
  </div>

  <div id="numeric-section" style="display:none;">
    {% for i in range(4) %}
      <label>Label {{ i + 1 }}:</label>
      <input type="text" name="label{{ i }}" value="{{ question.answers[i]['label'] if question and question.type == 'numeric' and question.answers|length > i else '' }}">
      <label>Answer {{ i + 1 }}:</label>
      <input type="number" name="num_answer{{ i }}" value="{{ question.answers[i]['answer'] if question and question.type == 'numeric' and question.answers|length > i else '' }}"><br>
    {% endfor %}
  </div>

  <div id="fill-in-the-blank-en-section" style="display:none;">
    <label>正解（英語）:</label>
    <input type="text" name="answer_fill_in_the_blank_en" value="{{ question.answer if question and question.type == 'fill_in_the_blank_en' else '' }}">
  </div>

  <div id="svg-interactive-section" style="display:none;">
    <label>SVGコンテンツ:</label>
    <textarea name="svg_content" id="svg-content-textarea" rows="10" cols="60">{{ question.choices if question and question.type == 'svg_interactive' else '' }}</textarea><br>
    <button type="button" id="svg-preview-button" class="button">SVGプレビュー</button><br>
    <label>追加文:</label>
    <div id="sub-questions-container">
      {% if question and question.type == 'svg_interactive' and answers %}
        {% for sub_q in answers %}
          <div class="sub-question">
            <input type="hidden" name="sub_id" value="{{ sub_q.id }}">
            <div>
              <label>問題文 (Markdown):</label>
              <textarea name="sub_prompt" rows="2" cols="50" class="sub-prompt-input">{{ sub_q.prompt }}</textarea>
              <div class="markdown-preview sub-prompt-preview"></div>
            </div>
            <div>
              <label>正答:</label>
              <input type="text" name="sub_answer" placeholder="正答" value="{{ sub_q.answer }}">
            </div>
            <button type="button" class="remove-sub-question">削除</button>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    <button type="button" id="add-sub-question">追加文を追加</button>
  </div>

  <div id="function-graph-section" style="display:none;">
      <div id="function-entries-container">
          {# JavaScript will populate this #}
      </div>
      <button type="button" id="add-function-entry">方程式を追加</button>
      <input type="hidden" name="answer_function_graph" id="answer_function_graph_hidden">
  </div>

<!-- 保存ボタン：上段 -->
<br>
<button type="submit" name="action" value="save_question">保存</button>
<!-- 戻るボタン：下段 -->
<div style="margin-top: 1rem;">
  <a href="{{ url_for('edit_quest', quest_id=quest_id, title=title, level=level) }}" class="button">クエスト編集に戻る</a>
</div>
</form>

<style>
  .markdown-preview {
    border: 1px solid #ccc;
    padding: 0.5rem;
    background-color: #f9f9f9;
    border-radius: 4px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\(', '\)']],
      displayMath: [['$$', '$$'], ['\[', '\]']]
    },
    svg: { fontCache: 'global' },
    startup: {
      ready: () => {
        console.log('MathJax is now ready to process math.');
        // Initial preview rendering after MathJax is fully loaded
        updatePreviews();
        MathJax.startup.defaultReady();
      }
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

<script>
  // Marked.js の設定を MathJax と共存できるように変更
  marked.setOptions({
    gfm: true,
    breaks: true
  });

  async function updatePreviews() {
      const allPreviews = [
        { inputId: "text-input", previewId: "text-preview" },
        { inputId: "explanation-input", previewId: "explanation-preview" },
      ];
      for (let i = 0; i < 4; i++) {
        allPreviews.push({ inputId: `choice${i}`, previewId: `choice${i}_preview` });
      }

      for (const item of allPreviews) {
        const inputEl = document.getElementById(item.inputId);
        const previewEl = document.getElementById(item.previewId);

        if (inputEl && previewEl) {
          try {
            const markdown = inputEl.value || '';
            previewEl.innerHTML = marked.parse(markdown);
            // Add a safeguard in case this is called before MathJax is ready
            if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
              await MathJax.typesetPromise([previewEl]);
            }
          } catch (e) {
            console.error(`Error updating preview for #${item.inputId}:`, e);
            if(previewEl) previewEl.innerHTML = "<p style='color: red;'>プレビューの生成中にエラーが発生しました。</p>";
          }
        }
      }
    }

  document.addEventListener('DOMContentLoaded', () => {
    const typeSelect = document.getElementById('type-select');
    const sections = {
        choice: document.getElementById('choice-section'),
        multiple_choice: document.getElementById('choice-section'),
        sort: document.getElementById('sort-section'),
        numeric: document.getElementById('numeric-section'),
        fill_in_the_blank_en: document.getElementById('fill-in-the-blank-en-section'),
        svg_interactive: document.getElementById('svg-interactive-section'),
        function_graph: document.getElementById('function-graph-section')
    };

    function updateSections() {
        const selectedType = typeSelect.value;
        for (const type in sections) {
            if (sections[type]) {
                sections[type].style.display = (type === selectedType || (selectedType === 'multiple_choice' && type === 'choice')) ? 'block' : 'none';
            }
        }
    }
    
    async function updateSubQuestionPreview(inputElement) {
      const preview = inputElement.nextElementSibling;
      preview.innerHTML = marked.parse(inputElement.value);
      await MathJax.typesetPromise([preview]);
    }

    // Initial setup
    updateSections();
    // The initial call to updatePreviews() is now handled by the MathJax.startup.ready callback
    // to ensure the library is loaded before we try to use it.
    
    // Event Listeners
    typeSelect.addEventListener('change', updateSections);
    document.getElementById("text-input").addEventListener("input", updatePreviews);
    document.getElementById("explanation-input").addEventListener("input", updatePreviews);
    for (let i = 0; i < 4; i++) {
      const choiceInput = document.getElementById(`choice${i}`);
      if (choiceInput) choiceInput.addEventListener("input", updatePreviews);
    }
    
    // Sub-question logic
    const subQuestionsContainer = document.getElementById('sub-questions-container');
    if (subQuestionsContainer) {
        let subQuestionCounter = subQuestionsContainer.querySelectorAll('.sub-question').length;
        
        subQuestionsContainer.querySelectorAll('.sub-prompt-input').forEach(input => {
            updateSubQuestionPreview(input);
            input.addEventListener('input', () => updateSubQuestionPreview(input));
        });

        document.getElementById('add-sub-question').addEventListener('click', () => {
            subQuestionCounter++;
            const newSubQuestion = document.createElement('div');
            newSubQuestion.classList.add('sub-question');
            newSubQuestion.innerHTML = `
                <input type="hidden" name="sub_id" value="sub${subQuestionCounter}">
                <div>
                  <label>問題文 (Markdown):</label>
                  <textarea name="sub_prompt" rows="2" cols="50" class="sub-prompt-input"></textarea>
                  <div class="markdown-preview sub-prompt-preview"></div>
                </div>
                <div>
                  <label>正答:</label>
                  <input type="text" name="sub_answer" placeholder="正答">
                </div>
                <button type="button" class="remove-sub-question">削除</button>
            `;
            subQuestionsContainer.appendChild(newSubQuestion);
            const newInput = newSubQuestion.querySelector('.sub-prompt-input');
            updateSubQuestionPreview(newInput);
            newInput.addEventListener('input', () => updateSubQuestionPreview(newInput));
        });

        subQuestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-sub-question')) {
                e.target.parentElement.remove();
            }
        });
    }

    // SVG Preview Logic
    const svgPreviewButton = document.getElementById('svg-preview-button');
    if (svgPreviewButton) {
      svgPreviewButton.addEventListener('click', () => {
        const svgContent = document.getElementById('svg-content-textarea').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for('main.svg_preview') }}';
        form.target = '_blank';
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'svg_data';
        hiddenField.value = svgContent;
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
      });
    }

    // --- Function Graph Section Logic ---
    const functionEntriesContainer = document.getElementById('function-entries-container');
    const addFunctionEntryBtn = document.getElementById('add-function-entry');
    const hiddenFunctionGraphInput = document.getElementById('answer_function_graph_hidden');
    const mainForm = document.querySelector('form');

    function serializeFunctionEntries() {
        if (typeSelect.value !== 'function_graph') return;
        const entries = [];
        functionEntriesContainer.querySelectorAll('.function-entry').forEach(entryEl => {
            const fnInput = entryEl.querySelector('.function-fn-input');
            const captionInput = entryEl.querySelector('.function-caption-input');
            if (fnInput && captionInput) {
                entries.push({
                    fn: fnInput.value,
                    caption: captionInput.value
                });
            }
        });
        hiddenFunctionGraphInput.value = JSON.stringify(entries);
    }

    function createFunctionEntry(fn = '', caption = '') {
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('function-entry');

        const fnInput = document.createElement('input');
        fnInput.type = 'text';
        fnInput.className = 'function-fn-input';
        fnInput.placeholder = '方程式 (例: 2*x, x^2, sin(x), 1/x)';
        fnInput.value = fn;

        const captionInput = document.createElement('input');
        captionInput.type = 'text';
        captionInput.className = 'function-caption-input';
        captionInput.placeholder = 'キャプション (Markdown/LaTeX)';
        captionInput.value = caption;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-function-entry';
        removeBtn.textContent = '削除';

        entryDiv.appendChild(fnInput);
        entryDiv.appendChild(captionInput);
        entryDiv.appendChild(removeBtn);
        functionEntriesContainer.appendChild(entryDiv);
    }

    if (addFunctionEntryBtn) {
        addFunctionEntryBtn.addEventListener('click', () => {
            createFunctionEntry();
        });
    }
    
    if (functionEntriesContainer) {
        functionEntriesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-function-entry')) {
                e.target.closest('.function-entry').remove();
            }
        });
    }

    if (mainForm) {
        mainForm.addEventListener('submit', serializeFunctionEntries);
    }

    // Populate existing function graph data on load
    if (typeSelect.value === 'function_graph') {
        const existingDataRaw = `{{ question.answer | default('[]') | safe }}`;
        try {
            const existingData = JSON.parse(existingDataRaw);
            if (Array.isArray(existingData) && existingData.length > 0) {
                existingData.forEach(item => createFunctionEntry(item.fn || '', item.caption || ''));
            } else if (typeof existingData === 'string' && existingData.trim() !== '' && !existingData.trim().startsWith('[')) {
                // Handle old single-string format
                createFunctionEntry(existingData, '');
            } else {
                createFunctionEntry(); // Add one empty entry if no valid data
            }
        } catch(e) {
            // Handle non-JSON string (old format)
            if (existingDataRaw && !existingDataRaw.trim().startsWith('[')) {
                createFunctionEntry(existingDataRaw, '');
            } else {
                createFunctionEntry(); // Add one empty entry on error
            }
        }
    }
  });
</script>

{% endblock %}
