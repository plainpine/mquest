<!-- templates/edit_question.html -->
{% extends "base.html" %}
{% block title %}問題編集{% endblock %}

{% block content %}
<h2>問題編集</h2>
<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type=number] {
      -webkit-appearance: none;
      appearance: none;
      -moz-appearance: textfield;
    }
    .sub-question, .function-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .sub-question > div {
      margin-bottom: 5px;
    }
    .sub-question label {
      font-weight: bold;
    }
    .function-entry {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .function-entry input {
        flex: 1;
    }
    .remove-function-entry {
        background: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
    }
</style>
<form method="post" action="{{ url_for('save_question', quest_id=quest_id, question_id=question.id if question else 'new') }}">
  <input type="hidden" name="title" value="{{ title }}">
  <input type="hidden" name="level" value="{{ level }}">
  <label>タイプ:</label>
  <select name="type" id="type-select">
    <option value="choice" {% if question and question.type == 'choice' %}selected{% endif %}>4択問題</option>
    <option value="multiple_choice" {% if question and question.type == 'multiple_choice' %}selected{% endif %}>複数選択</option>
    <option value="sort" {% if question and question.type == 'sort' %}selected{% endif %}>並び替え</option>
    <option value="numeric" {% if question and question.type == 'numeric' %}selected{% endif %}>数値入力</option>
    <option value="fill_in_the_blank_en" {% if question and question.type == 'fill_in_the_blank_en' %}selected{% endif %}>英語穴埋め</option>
    <option value="svg_interactive" {% if question and question.type == 'svg_interactive' %}selected{% endif %}>図形問題（入力）</option>
    <option value="figure_choice" {% if question and question.type == 'figure_choice' %}selected{% endif %}>図形問題（選択）</option>
    <option value="function_graph" {% if question and question.type == 'function_graph' %}selected{% endif %}>方程式グラフ</option>
    <option value="function_graph_choice" {% if question and question.type == 'function_graph_choice' %}selected{% endif %}>方程式グラフ（選択）</option>
  </select>

  <label for="text-input">問題文（Markdown）:</label>
  <textarea name="text" id="text-input" rows="4" cols="60">{{ question.text if question else '' }}</textarea>
  <div id="text-preview" class="markdown-preview" style="margin-bottom: 1rem;"></div>

  <label>解説（Markdown）:</label>
  <textarea name="explanation" id="explanation-input" rows="4" cols="60">{{ question.explanation or '' }}</textarea>
  <div id="explanation-preview" class="markdown-preview" style="margin-bottom: 1rem;"></div>

  <div id="choice-section" style="display:none;">
    <label>選択肢:</label><br>
    {% for i in range(4) %}
      <input type="text" name="choice{{ i }}" id="choice{{ i }}" value="{{ choices[i] if question and (question.type == 'choice' or question.type == 'multiple_choice') and question.choices|length > i else '' }}"><br>
      <div id="choice{{ i }}_preview" class="markdown-preview" style="margin-bottom: 0.5rem;"></div>
    {% endfor %}
    <label>正解:</label>
    <input type="text" name="answer" value="{{ question.answer if question and (question.type == 'choice' or question.type == 'multiple_choice') else '' }}" placeholder="単一選択は正解、複数選択はカンマ区切り（例: A,C）">
  </div>

  <div id="sort-section" style="display:none;">
    <label>正解の並び順（文字列）:</label>
    <input type="text" name="answer_sort" value="{% if question and question.type == 'sort' %}{{ question.answer or '' }}{% endif %}">
  </div>

  <div id="numeric-section" style="display:none;">
    {% for i in range(4) %}
      <label>Label {{ i + 1 }}:</label>
      <input type="text" name="label{{ i }}" value="{{ question.answers[i]['label'] if question and question.type == 'numeric' and question.answers|length > i else '' }}">
      <label>Answer {{ i + 1 }}:</label>
      <input type="number" name="num_answer{{ i }}" value="{{ question.answers[i]['answer'] if question and question.type == 'numeric' and question.answers|length > i else '' }}"><br>
    {% endfor %}
  </div>

  <div id="fill-in-the-blank-en-section" style="display:none;">
    <label>正解（英語）:</label>
    <input type="text" name="answer_fill_in_the_blank_en" value="{{ question.answer if question and question.type == 'fill_in_the_blank_en' else '' }}">
  </div>

  <div id="svg-interactive-section" style="display:none;">
    <label>SVGコンテンツ:</label>
    <textarea name="svg_content" id="svg-content-textarea" rows="10" cols="60">{{ question.choices if question and question.type == 'svg_interactive' else '' }}</textarea><br>
    <button type="button" id="svg-preview-button" class="button">SVGプレビュー</button><br>
    <label>追加文:</label>
    <div id="sub-questions-container">
      {% if question and question.type == 'svg_interactive' and answers %}
        {% for sub_q in answers %}
          <div class="sub-question">
            <input type="hidden" name="sub_id" value="{{ sub_q.id }}">
            <div>
              <label>問題文 (Markdown):</label>
              <textarea name="sub_prompt" rows="2" cols="50" class="sub-prompt-input">{{ sub_q.prompt }}</textarea>
              <div class="markdown-preview sub-prompt-preview"></div>
            </div>
            <div>
              <label>正答:</label>
              <input type="text" name="sub_answer" placeholder="正答" value="{{ sub_q.answer }}">
            </div>
            <button type="button" class="remove-sub-question">削除</button>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    <button type="button" id="add-sub-question">追加文を追加</button>
  </div>

  <div id="figure-choice-section" style="display:none;">
    <label for="figure-choice-svg-content">SVGコンテンツ:</label>
    <textarea name="figure_choice_svg_content" id="figure-choice-svg-content" rows="10" cols="60">{{ question.choices if question and question.type == 'figure_choice' else '' }}</textarea><br>
    <button type="button" id="figure-choice-svg-preview-button" class="button">SVGプレビュー</button><br>
    <label>追加文:</label>
    <div id="figure-choice-sub-questions-container">
      {% if question and question.type == 'figure_choice' and answers %}
        {% for sub_q in answers %}
          {% set outer_loop_index = loop.index0 %}
          <div class="sub-question">
            <input type="hidden" name="figure_choice_sub_id" value="sub{{ loop.index0 }}">
            <div>
              <label>問題文 (Markdown):</label>
              <textarea name="figure_choice_sub_prompt" rows="2" cols="50" class="sub-prompt-input">{{ sub_q.prompt }}</textarea>
              <div class="markdown-preview sub-prompt-preview"></div>
            </div>
            <div>
              <label>選択肢:</label><br>
              {% for i in range(4) %}
                <input type="text" name="figure_choice_sub_choice_{{ outer_loop_index }}_{{ i }}" value="{{ sub_q.choices[i] if sub_q.choices is iterable and sub_q.choices|length > i else '' }}"><br>
              {% endfor %}
            </div>
            <div>
              <label>正答:</label>
              <input type="text" name="figure_choice_sub_answer" placeholder="正答" value="{{ sub_q.answer }}">
            </div>
            <button type="button" class="remove-sub-question">削除</button>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    <button type="button" id="add-figure-choice-sub-question">追加文を追加</button>
  </div>

  <div id="function-graph-section" style="display:none;">
      <h3>グラフ定義</h3>
      <div id="function-entries-container">
          {# JavaScript will populate this #}
      </div>
      <button type="button" id="add-function-entry">方程式を追加</button>
      <input type="hidden" name="answer_function_graph" id="answer_function_graph_hidden">

      <h3 style="margin-top: 1rem;">回答と正答</h3>
      <div id="function-graph-answers-container">
        {% if question and question.type == 'function_graph' and answers %}
          {% for ans in answers %}
            <div class="sub-question">
              <input type="hidden" name="function_graph_answer_id" value="{{ loop.index0 }}"> {# Use loop.index0 for a simple ID #}
              <div>
                <label>問題文 (Markdown):</label>
                <textarea name="function_graph_answer_prompt" rows="2" cols="50" class="sub-prompt-input">{{ ans.prompt }}</textarea>
                <div class="markdown-preview sub-prompt-preview"></div>
              </div>
              <div>
                <label>正答:</label>
                <input type="text" name="function_graph_correct_answer" placeholder="正答" value="{{ ans.answer }}">
              </div>
              <button type="button" class="remove-sub-question">削除</button>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      <button type="button" id="add-function-graph-answer">回答項目を追加</button>
      <input type="hidden" name="answers" id="answers_function_graph_hidden">
  </div>

  <div id="function-graph-choice-section" style="display:none;">
      <h3>グラフ定義</h3>
      <div id="function-graph-choice-entries-container">
          {# JavaScript will populate this section #}
      </div>
      <button type="button" id="add-function-graph-choice-entry">方程式を追加</button>
      <input type="hidden" name="function_graph_choice_definitions" id="function_graph_choice_definitions_hidden">

      <h3 style="margin-top: 1rem;">選択肢と正答</h3>
      <label>選択肢 (Markdown):</label><br>
      {% for i in range(4) %}
        <input type="text" name="fgc_choice{{ i }}" id="fgc_choice{{ i }}" value=""><br>
        <div id="fgc_choice{{ i }}_preview" class="markdown-preview" style="margin-bottom: 0.5rem;"></div>
      {% endfor %}
      <label>正解:</label>
      <input type="text" name="fgc_answer" value="" placeholder="選択肢の本文と一致させてください">
  </div>

<!-- 保存ボタン：上段 -->
<br>
<button type="submit">保存</button>
<button type="button" id="preview-button">プレビュー</button>
<!-- 戻るボタン：下段 -->
<div style="margin-top: 1rem;">
  <a href="{{ url_for('edit_quest', quest_id=quest_id, title=title, level=level) }}" class="button">クエスト編集に戻る</a>
</div>
</form>

<style>
  .markdown-preview {
    border: 1px solid #ccc;
    padding: 0.5rem;
    background-color: #f9f9f9;
    border-radius: 4px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\(', '\)']],
      displayMath: [['$$', '$$'], ['\[', '\]']]
    },
    svg: { fontCache: 'global' },
    startup: {
      ready: () => {
        console.log('MathJax is now ready to process math.');
        // Initial preview rendering after MathJax is fully loaded
        updatePreviews();
        MathJax.startup.defaultReady();
      }
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

<script>
    marked.setOptions({
        gfm: true,
        breaks: true
    });

    async function updatePreviews() {
      const allPreviews = [
        { inputId: "text-input", previewId: "text-preview" },
        { inputId: "explanation-input", previewId: "explanation-preview" },
      ];
      for (let i = 0; i < 4; i++) {
        allPreviews.push({ inputId: `choice${i}`, previewId: `choice${i}_preview` });
        allPreviews.push({ inputId: `fgc_choice${i}`, previewId: `fgc_choice${i}_preview` });
      }

      for (const item of allPreviews) {
        const inputEl = document.getElementById(item.inputId);
        const previewEl = document.getElementById(item.previewId);

        if (inputEl && previewEl) {
          try {
            const markdown = inputEl.value || '';
            previewEl.innerHTML = marked.parse(markdown);
            if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
              await MathJax.typesetPromise([previewEl]);
            }
          } catch (e) {
            console.error(`Error updating preview for #${item.inputId}:`, e);
            if(previewEl) previewEl.innerHTML = "<p style='color: red;'>プレビューの生成中にエラーが発生しました。</p>";
          }
        }
      }
    }

  document.addEventListener('DOMContentLoaded', () => {
    // --- Function Definitions ---
    function serializeFunctionEntries() {
        if (typeSelect.value !== 'function_graph') return;
        const functionEntriesContainer = document.getElementById('function-entries-container');
        const hiddenInput = document.getElementById('answer_function_graph_hidden');
        
        const entries = Array.from(functionEntriesContainer.querySelectorAll('.function-entry')).map(entryEl => {
            const fnInput = entryEl.querySelector('.function-fn-input');
            const captionInput = entryEl.querySelector('.function-caption-input');
            return { fn: fnInput.value, caption: captionInput.value };
        });
        hiddenInput.value = JSON.stringify(entries);
    }

    function serializeFunctionGraphChoiceEntries() {
        if (typeSelect.value !== 'function_graph_choice') return;
        const container = document.getElementById('function-graph-choice-entries-container');
        const hiddenInput = document.getElementById('function_graph_choice_definitions_hidden');
        
        const entries = Array.from(container.querySelectorAll('.function-entry')).map(entryEl => {
            const fnInput = entryEl.querySelector('.function-fn-input');
            const captionInput = entryEl.querySelector('.function-caption-input');
            return { fn: fnInput.value, caption: captionInput.value };
        });
        hiddenInput.value = JSON.stringify(entries);
    }

    function serializeFunctionGraphAnswers() {
        if (typeSelect.value !== 'function_graph') return;
        const container = document.getElementById('function-graph-answers-container');
        const hiddenInput = document.getElementById('answers_function_graph_hidden');
        
        const answers = Array.from(container.querySelectorAll('.sub-question')).map(answerEl => {
            const promptInput = answerEl.querySelector('textarea[name="function_graph_answer_prompt"]');
            const correctAnswerInput = answerEl.querySelector('input[name="function_graph_correct_answer"]');
            return { prompt: promptInput.value, answer: correctAnswerInput.value };
        });
        hiddenInput.value = JSON.stringify(answers);
    }

    function updateSections() {
        const selectedType = typeSelect.value;
        const textInputLabel = document.querySelector('label[for="text-input"]');
        
        // Hide all sections
        Object.values(sections).forEach(section => {
            if (section) section.style.display = 'none';
        });

        // Show the correct one
        if (sections[selectedType]) {
            sections[selectedType].style.display = 'block';
        }
    }
    
    async function updateSubQuestionPreview(inputElement) {
      if (!inputElement || !inputElement.nextElementSibling) return;
      const preview = inputElement.nextElementSibling;
      preview.innerHTML = marked.parse(inputElement.value);
      if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
        await MathJax.typesetPromise([preview]);
      }
    }

    function createFunctionEntry(fn = '', caption = '') {
        const container = document.getElementById('function-entries-container');
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('function-entry');

        entryDiv.innerHTML = `
            <input type="text" class="function-fn-input" placeholder="方程式 (例: 2*x, x^2)" value="${fn}">
            <input type="text" class="function-caption-input" placeholder="キャプション (Markdown/LaTeX)" value="${caption}">
            <button type="button" class="remove-function-entry">削除</button>
        `;
        container.appendChild(entryDiv);
    }

    function createFunctionGraphChoiceEntry(fn = '', caption = '') {
        const container = document.getElementById('function-graph-choice-entries-container');
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('function-entry');

        entryDiv.innerHTML = `
            <input type="text" class="function-fn-input" placeholder="方程式 (例: 2*x, x^2)" value="${fn}">
            <input type="text" class="function-caption-input" placeholder="キャプション (Markdown/LaTeX)" value="${caption}">
            <button type="button" class="remove-function-entry">削除</button>
        `;
        container.appendChild(entryDiv);
    }

    function createFunctionGraphAnswerEntry(prompt = '', answer = '') {
        const container = document.getElementById('function-graph-answers-container');
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('sub-question');

        entryDiv.innerHTML = `
            <input type="hidden" name="function_graph_answer_id" value="">
            <div>
              <label>問題文 (Markdown):</label>
              <textarea name="function_graph_answer_prompt" rows="2" cols="50" class="sub-prompt-input">${prompt}</textarea>
              <div class="markdown-preview sub-prompt-preview"></div>
            </div>
            <div>
              <label>正答:</label>
              <input type="text" name="function_graph_correct_answer" placeholder="正答" value="${answer}">
            </div>
            <button type="button" class="remove-sub-question">削除</button>
        `;
        container.appendChild(entryDiv);
        
        const promptInput = entryDiv.querySelector('.sub-prompt-input');
        updateSubQuestionPreview(promptInput);
        promptInput.addEventListener('input', () => updateSubQuestionPreview(promptInput));
    }

    // --- Main Execution ---
    const typeSelect = document.getElementById('type-select');
    const sections = {
        choice: document.getElementById('choice-section'),
        multiple_choice: document.getElementById('choice-section'),
        sort: document.getElementById('sort-section'),
        numeric: document.getElementById('numeric-section'),
        fill_in_the_blank_en: document.getElementById('fill-in-the-blank-en-section'),
        svg_interactive: document.getElementById('svg-interactive-section'),
        figure_choice: document.getElementById('figure-choice-section'),
        function_graph: document.getElementById('function-graph-section'),
        function_graph_choice: document.getElementById('function-graph-choice-section')
    };
    const mainForm = document.querySelector('form');

    updateSections(); // Initial display update
    
    // Event Listeners
    typeSelect.addEventListener('change', updateSections);
    document.getElementById("text-input").addEventListener("input", updatePreviews);
    document.getElementById("explanation-input").addEventListener("input", updatePreviews);
    for (let i = 0; i < 4; i++) {
      const choiceInput = document.getElementById(`choice${i}`);
      if (choiceInput) choiceInput.addEventListener("input", updatePreviews);
      const fgcChoiceInput = document.getElementById(`fgc_choice${i}`);
      if (fgcChoiceInput) fgcChoiceInput.addEventListener("input", updatePreviews);
    }
    
    // Sub-question logic (for svg_interactive)
    const subQuestionsContainer = document.getElementById('sub-questions-container');
    if (subQuestionsContainer) {
        subQuestionsContainer.querySelectorAll('.sub-prompt-input').forEach(input => {
            updateSubQuestionPreview(input);
            input.addEventListener('input', () => updateSubQuestionPreview(input));
        });

        document.getElementById('add-sub-question').addEventListener('click', () => {
            const subQuestionCounter = subQuestionsContainer.querySelectorAll('.sub-question').length;
            const newSubQuestion = document.createElement('div');
            newSubQuestion.classList.add('sub-question');
            newSubQuestion.innerHTML = `
                <input type="hidden" name="sub_id" value="sub${subQuestionCounter}">
                <div>
                  <label>問題文 (Markdown):</label>
                  <textarea name="sub_prompt" rows="2" cols="50" class="sub-prompt-input"></textarea>
                  <div class="markdown-preview sub-prompt-preview"></div>
                </div>
                <div>
                  <label>正答:</label>
                  <input type="text" name="sub_answer" placeholder="正答">
                </div>
                <button type="button" class="remove-sub-question">削除</button>
            `;
            subQuestionsContainer.appendChild(newSubQuestion);
            const newInput = newSubQuestion.querySelector('.sub-prompt-input');
            updateSubQuestionPreview(newInput);
            newInput.addEventListener('input', () => updateSubQuestionPreview(newInput));
        });

        subQuestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-sub-question')) {
                e.target.parentElement.remove();
            }
        });
    }

    // Figure Choice Sub-question logic
    const figureChoiceSubQuestionsContainer = document.getElementById('figure-choice-sub-questions-container');
    if (figureChoiceSubQuestionsContainer) {
        figureChoiceSubQuestionsContainer.querySelectorAll('.sub-prompt-input').forEach(input => {
            updateSubQuestionPreview(input);
            input.addEventListener('input', () => updateSubQuestionPreview(input));
        });

        document.getElementById('add-figure-choice-sub-question').addEventListener('click', () => {
            const subQuestionCounter = figureChoiceSubQuestionsContainer.querySelectorAll('.sub-question').length;
            const newSubQuestion = document.createElement('div');
            newSubQuestion.classList.add('sub-question');
            newSubQuestion.innerHTML = `
                <input type="hidden" name="figure_choice_sub_id" value="new${subQuestionCounter}">
                <div>
                    <label>問題文 (Markdown):</label>
                    <textarea name="figure_choice_sub_prompt" rows="2" cols="50" class="sub-prompt-input"></textarea>
                    <div class="markdown-preview sub-prompt-preview"></div>
                </div>
                <div>
                    <label>選択肢:</label><br>
                    <input type="text" name="figure_choice_sub_choice_${subQuestionCounter}_0" placeholder="選択肢A"><br>
                    <input type="text" name="figure_choice_sub_choice_${subQuestionCounter}_1" placeholder="選択肢B"><br>
                    <input type="text" name="figure_choice_sub_choice_${subQuestionCounter}_2" placeholder="選択肢C"><br>
                    <input type="text" name="figure_choice_sub_choice_${subQuestionCounter}_3" placeholder="選択肢D"><br>
                </div>
                <div>
                    <label>正答:</label>
                    <input type="text" name="figure_choice_sub_answer" placeholder="正答 (例: A)">
                </div>
                <button type="button" class="remove-sub-question">削除</button>
            `;
            figureChoiceSubQuestionsContainer.appendChild(newSubQuestion);
            const newInput = newSubQuestion.querySelector('.sub-prompt-input');
            updateSubQuestionPreview(newInput);
            newInput.addEventListener('input', () => updateSubQuestionPreview(newInput));
        });

        figureChoiceSubQuestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-sub-question')) {
                e.target.closest('.sub-question').remove();
            }
        });
    }

    // SVG Preview Logic
    const svgPreviewButton = document.getElementById('svg-preview-button');
    if (svgPreviewButton) {
      svgPreviewButton.addEventListener('click', () => {
        const svgContent = document.getElementById('svg-content-textarea').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for('main.svg_preview') }}';
        form.target = '_blank';
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'svg_data';
        hiddenField.value = svgContent;
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
      });
    }

    const figureChoiceSvgPreviewButton = document.getElementById('figure-choice-svg-preview-button');
    if (figureChoiceSvgPreviewButton) {
      figureChoiceSvgPreviewButton.addEventListener('click', () => {
        const svgContent = document.getElementById('figure-choice-svg-content').value; // Use new svg content text area
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for('main.svg_preview') }}';
        form.target = '_blank';
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'svg_data';
        hiddenField.value = svgContent;
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
      });
    }


    // --- Function Graph Section Logic ---
    const functionEntriesContainer = document.getElementById('function-entries-container');
    if (functionEntriesContainer) {
        document.getElementById('add-function-entry').addEventListener('click', () => createFunctionEntry());
        functionEntriesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-function-entry')) {
                e.target.closest('.function-entry').remove();
            }
        });
    }

    // --- Function Graph Choice Section Logic ---
    const functionGraphChoiceEntriesContainer = document.getElementById('function-graph-choice-entries-container');
    if (functionGraphChoiceEntriesContainer) {
        document.getElementById('add-function-graph-choice-entry').addEventListener('click', () => createFunctionGraphChoiceEntry());
        functionGraphChoiceEntriesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-function-entry')) {
                e.target.closest('.function-entry').remove();
            }
        });
    }

    // --- Function Graph Answer Section Logic ---
    const functionGraphAnswersContainer = document.getElementById('function-graph-answers-container');
    if (functionGraphAnswersContainer) {
        document.getElementById('add-function-graph-answer').addEventListener('click', () => createFunctionGraphAnswerEntry());
        functionGraphAnswersContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-sub-question')) {
                e.target.closest('.sub-question').remove();
            }
        });
    }

    // Form Submission Logic
    if (mainForm) {
        mainForm.addEventListener('submit', (e) => {
            serializeFunctionEntries();
            serializeFunctionGraphAnswers();
            serializeFunctionGraphChoiceEntries();
        });
    }

    // Initial population for function_graph
    if (typeSelect.value === 'function_graph') {
        const existingGraphDataRaw = `{{ question.answer | default('[]') | safe }}`;
        try {
            const existingGraphData = JSON.parse(existingGraphDataRaw);
            if (Array.isArray(existingGraphData) && existingGraphData.length > 0) {
                existingGraphData.forEach(item => createFunctionEntry(item.fn || '', item.caption || ''));
            } else { createFunctionEntry(); }
        } catch(e) { createFunctionEntry(); }

        const existingAnswersRaw = `{{ answers | default('[]') | tojson | safe }}`;
        try {
            const existingAnswers = JSON.parse(existingAnswersRaw);
            if (Array.isArray(existingAnswers)) {
                existingAnswers.forEach(item => createFunctionGraphAnswerEntry(item.prompt || '', item.answer || ''));
            }
        } catch(e) { console.error("Error parsing existing function graph answers:", e); }
    }
    
    // Preview Button Logic
    document.getElementById('preview-button').addEventListener('click', function() {
        if (document.getElementById('type-select').value === 'function_graph') {
            serializeFunctionEntries();
            serializeFunctionGraphAnswers();
        }
        if (document.getElementById('type-select').value === 'function_graph_choice') {
            serializeFunctionGraphChoiceEntries();
        }
        
        const form = document.querySelector('form');
        const originalAction = form.action;
        const originalTarget = form.target;
        form.action = "{{ url_for('preview_question') }}";
        form.target = '_blank';
        form.submit();
        form.action = originalAction;
        form.target = originalTarget;
    });
  });
</script>

{% endblock %}