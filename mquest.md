# MQuest 仕様書

## 1. 概要

MQuestは、生徒がクエスト（問題集）をクリアしていくことで学習を進める、ゲーミフィケーション要素を取り入れたWebアプリケーションである。
ユーザーは「生徒」「保護者」「管理者」の3つの役割に分かれ、それぞれ異なる機能を利用できる。
生徒はクエストに挑戦してメダルや称号を獲得し、学習の進捗を「世界地図」の制覇という形で視覚的に確認できる。管理者はクエストや問題の作成・編集を行い、保護者は子供の学習状況を把握することができる。

## 2. 機能仕様

### 2.1. ユーザー管理

#### 2.1.1. ロール（役割）

本システムは以下の3つのユーザーロールを持つ。

- **生徒 (student)**: 学習の主体。クエストに挑戦し、進捗を確認する。
- **保護者 (parent)**: 生徒の保護者。担当する子供の学習進捗を閲覧する。
- **管理者 (admin)**: システムの管理者。生徒、クエスト、問題の管理を行う。

#### 2.1.2. 認証

- **ログイン**: ユーザー名とパスワードで認証する。
- **初回ログイン**: 初回ログイン時には、パスワードの変更が強制される。
- **ログアウト**: セッションを破棄し、ログインページにリダイレクトする。
- **アクセス制御**: 各ページはロールに基づいてアクセスが制御される。

### 2.2. 学習機能（生徒向け）

#### 2.2.1. ダッシュボード

- ログイン後、生徒専用のダッシュボードが表示される。
- 「世界制覇機能」に基づき、クリア済みのクエストがマップ上に表示される。

#### 2.2.2. クエスト選択

1.  **科目選択**: 「数学」「英語」「国語」などの科目（タイトル）を選択する。
2.  **レベル選択**: 選択した科目の難易度（レベル）を選択する。
3.  **クエスト選択**: 上記で絞り込まれたクエストの一覧から、挑戦したいクエストを選択する。

#### 2.2.3. クエスト実行

- 選択したクエストの問題が順に表示される。
- 問題形式は多岐にわたる。
    - **選択式 (choice)**: 複数の選択肢から正解を選ぶ。
    - **並び替え式 (sort)**: 単語や文を正しい順序に並び替える。
    - **記述式 (fill_in_the_blank_en)**: 英単語などを直接入力する。
    - **数値入力式 (numeric)**: 計算問題の答えなどを数値で入力する。
    - **SVGインタラクティブ式 (svg_interactive)**: SVG画像上の特定の領域に数値を入力する。
- 全ての問題に解答後、結果を送信する。

#### 2.2.4. 結果表示

- 解答送信後、すぐに採点が行われ、正誤判定とスコアが表示される。
- 全問正解した場合、クエストは「クリア」済みとなる。
- クリア状況は `user_progress` テーブルに記録される。
- 挑戦履歴（挑戦回数、最終挑戦日時など）は `quest_history` テーブルに記録・更新される。

#### 2.2.5. 進捗確認

- **メダル**: クエストへの挑戦回数に応じてメダルが蓄積される。獲得したメダルはメダルページで一覧できる。
- **学習進捗**: 科目・レベルごとにクリアしたクエスト数が表示され、学習の達成度を確認できる。

#### 2.2.6. 世界制覇機能

- 生徒のダッシュボードに表示される主要機能。
- クエストには `world_name` （実世界地図）と `fantasy_name` （ファンタジー地図）が設定されている。
- 生徒がクエストをクリアすると、対応する地図上のエリアが「制覇済み」としてマークされる。
- これにより、学習の進捗が領土の拡大として視覚的に表現され、学習意欲の向上を促す。

### 2.3. 管理者機能

#### 2.3.1. 生徒管理

- 生徒アカウントの一覧を閲覧できる。
- 各生徒のニックネーム、学習進捗（クリア済みクエスト数）、メダル獲得状況を確認できる。

#### 2.3.2. クエスト管理

- クエストの一覧を閲覧、新規作成、編集、削除できる。
- クエストには科目（タイトル）とレベルを設定する。

#### 2.3.3. 問題管理

- 各クエストに紐づく問題を作成、編集、削除できる。
- `2.2.3. クエスト実行` で示した全ての形式の問題を作成可能。
- 問題文、選択肢（JSON形式）、解答（JSON形式）、解説文を設定できる。

### 2.4. 保護者機能

- 保護者アカウントに紐づけられた子供（生徒アカウント）の一覧を閲覧できる。
- 各子供の学習履歴やメダルの総数を確認し、学習状況を把握できる。

## 3. データベース設計

使用する主要なテーブルの定義は以下の通り。

### 3.1. `users` テーブル

ユーザー情報を格納する。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | Integer | 主キー |
| `username` | String | ユーザー名（ユニーク） |
| `password_hash` | String | ハッシュ化されたパスワード |
| `role` | String | 役割 ('admin', 'student', 'parent') |
| `is_first_login` | Boolean | 初回ログインフラグ |
| `nickname` | String | ニックネーム |
| `parent_id` | Integer | 保護者のユーザーID（外部キー） |
| `user_level` | Integer | ユーザーレベル |
| `medals` | Integer | 獲得メダル総数 |
| `user_title` | String | 称号 |

### 3.2. `quests` テーブル

クエストの基本情報を格納する。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | Integer | 主キー |
| `title` | String | 科目（例: 'math', 'english'） |
| `level` | String | 難易度レベル |
| `world_name` | String | 世界制覇機能で利用する実世界マップ名 |
| `fantasy_name` | String | 世界制覇機能で利用するファンタジーマップ名 |

### 3.3. `questions` テーブル

各クエストに含まれる問題を格納する。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | Integer | 主キー |
| `quest_id` | Integer | `quests.id`への外部キー |
| `type` | String | 問題形式（'choice', 'sort'など） |
| `text` | Text | 問題文 |
| `choices` | Text | 選択肢（JSON形式） |
| `answer` | Text | 正解（JSON形式） |
| `explanation` | Text | 解説文 |

### 3.4. `quest_history` テーブル

生徒のクエスト挑戦履歴を格納する。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | Integer | 主キー |
| `user_id` | Integer | `users.id`への外部キー |
| `quest_id` | Integer | `quests.id`への外部キー |
| `is_cleared` | Boolean | クリア済みかどうかのフラグ |
| `attempts` | Integer | 挑戦回数 |
| `last_attempt` | DateTime | 最終挑戦日時 |

### 3.5. `user_progress` テーブル

生徒のクエストクリア状況を管理する。

| カラム名 | 型 | 説明 |
|:---|:---|:---|
| `id` | Integer | 主キー |
| `user_id` | Integer | `users.id`への外部キー |
| `quest_id` | Integer | `quests.id`への外部キー |
| `status` | String | 状態（'unlocked', 'cleared'） |
| `conquered_at` | DateTime | クリア（制覇）した日時 |

## 4. 画面仕様

### 4.1. 共通画面

#### 4.1.1. ログイン画面 (`login.html`)
- **機能**: ユーザー認証を行う。
- **詳細**: ユーザー名とパスワードを入力し、ログインボタンをクリックする。認証成功後は各ロールのダッシュボードへ、失敗時はエラーメッセージを表示する。

#### 4.1.2. パスワード変更画面 (`change_password.html`)
- **機能**: 初回ログイン時にパスワードを変更する。
- **詳細**: 新しいパスワードと確認用のパスワードを入力する。両者が一致しない場合や空の場合はエラーメッセージを表示する。成功後はダッシュボードへ遷移する。

### 4.2. 生徒用画面

#### 4.2.1. ダッシュボード (`dashboard_student.html`)
- **機能**: 学習のハブとなる画面。世界制覇の状況を視覚的に表示する。
- **詳細**: クリア済みのクエストに対応するマップが表示され、制覇状況が更新される。ここからクエスト選択や進捗確認画面へ遷移する。

#### 4.2.2. クエスト選択画面 (`select_title.html`, `select_level.html`, `select_quest.html`)
- **機能**: 挑戦するクエストを選択する。
- **詳細**: 「科目」→「レベル」→「クエスト名」の順でドリルダウンしていく。選択したクエストの実行画面へ遷移する。

#### 4.2.3. クエスト実行画面 (`quest_run.html`)
- **機能**: クエストの問題に解答する。
- **詳細**: 問題文と解答形式（選択、並び替え、記述等）が表示される。全ての問いに解答し、「解答する」ボタンで結果を送信する。

#### 4.2.4. クエスト結果画面 (`quest_result.html`)
- **機能**: 実行したクエストの採点結果を表示する。
- **詳細**: 各問題の正誤、ユーザーの解答、正解が表示される。全問正解かどうかの総合結果も通知される。

#### 4.2.5. 学習進捗画面 (`progress.html`)
- **機能**: これまでの学習成果を確認する。
- **詳細**: 科目・レベルごとにクリアしたクエストの数が一覧表示される。

#### 4.2.6. メダル確認画面 (`medals.html`)
- **機能**: 獲得したメダル（クエストへの挑戦回数）を確認する。
- **詳細**: クエストごとに挑戦回数が表示され、学習の努力量を振り返ることができる。

### 4.3. 管理者用画面

#### 4.3.1. ダッシュボード (`dashboard_admin.html`)
- **機能**: 管理機能へのエントリーポイント。
- **詳細**: 「生徒管理」「クエスト管理」など、各種管理ページへのリンクが設置されている。

#### 4.3.2. 生徒管理画面 (`manage_students.html`)
- **機能**: 全ての生徒の学習状況を一覧・確認する。
- **詳細**: 生徒のニックネーム、各科目の進捗（クリア済みクエスト数）、メダル獲得状況が表示される。

#### 4.3.3. クエスト管理画面 (`list_quests.html`)
- **機能**: クエストの追加、編集、削除を行う。
- **詳細**: 登録されているクエストが一覧表示される。ここからクエストの新規作成や、既存クエストの編集画面へ遷移する。クエストを選択して削除することも可能。

#### 4.3.4. クエスト編集画面 (`edit_quest.html`)
- **機能**: 既存クエストの情報（科目、レベル）を編集し、紐づく問題を管理する。
- **詳細**: クエスト情報の編集フォームと、そのクエストに含まれる問題の一覧が表示される。問題の追加、編集、削除ボタンが設置されている。

#### 4.3.5. 問題編集画面 (`edit_question.html`)
- **機能**: 問題の作成・編集を行う。
- **詳細**: 問題形式（選択式、記述式など）を選択し、問題文、選択肢、正解、解説などを入力するフォーム。SVGインタラクティブ問題のような複雑な形式にも対応する。

#### 4.3.6. グループ学習画面 (`group_learning.html`)
- **機能**: 管理者がクエストをスクリーンに表示し、グループでの学習活動に使用する。
- **詳細**: `quest_run.html`と似ているが、生徒の解答入力や採点機能はなく、問題と解答を順番に表示することに特化している。

### 4.4. 保護者用画面

#### 4.4.1. ダッシュボード (`dashboard_parent.html`)
- **機能**: 保護者向け機能へのエントリーポイント。
- **詳細**: 自身の子供の学習状況を確認するページへのリンクが設置されている。

#### 4.4.2. 子供の進捗確認画面 (`parent_students.html`)
- **機能**: 担当する子供の学習状況を詳細に確認する。
- **詳細**: 子供ごとに、クエストの挑戦履歴や獲得メダル総数が一覧表示される。

## 5. 技術スタック

- **バックエンド**: Python, Flask
- **データベース**: SQLite (SQLAlchemy ORM経由)
- **フロントエンド**: HTML, CSS, JavaScript
- **認証**: Flask-Login
- **その他**: Jinja2 (テンプレートエンジン)

## 6. データフォーマット

### 6.1. `quests.json`

`scripts/add_sample_quests.py` スクリプトによってデータベースに初期データとして登録される、クエストと問題の情報を定義したJSONファイルです。

#### 6.1.1. 全体構造

- ルートは単一のJSONオブジェクトです。
- 各キー（例: "1", "2"）はクエストセットの一意なIDを表します。
- 各クエストセットは、`title`, `level`, `questions`の3つのキーを持ちます。

```json
{
  "1": {
    "title": "計算選択問題",
    "level": "Lv1",
    "questions": [ ... ]
  },
  "2": {
    "title": "英語文法",
    "level": "Lv1",
    "questions": [ ... ]
  }
}
```

#### 6.1.2. クエストセットの構造

| キー | 型 | 説明 |
|:---|:---|:---|
| `title` | String | クエストの日本語タイトル。スクリプト実行時に英語の識別子（`math`, `english`等）に変換されます。 |
| `level` | String | クエストの難易度レベル（例: "Lv1"）。 |
| `questions` | Array | そのクエストに含まれる問題オブジェクトの配列。 |

#### 6.1.3. 問題オブジェクトの構造

`questions`配列内の各オブジェクトは、単一の問題を表します。構造は問題の`type`によって異なります。

**共通のキー**

| キー | 型 | 説明 |
|:---|:---|:---|
| `type` | String | 問題の形式。("choice", "sort", "numeric", "svg_interactive", "fill_in_the_blank_en") |
| `text` | String | 問題文。MarkdownやLaTeX形式の文字列も利用可能です。 |
| `explanation` | String | (任意) 問題の解説文。 |

**`type`別のキー**

- **`type: "choice"`** (選択問題)
  - `choices`: (Array) 選択肢の文字列を格納した配列。
  - `answer`: (Integer) 正解の選択肢のインデックス（0始まり）。

- **`type: "sort"`** (並び替え問題)
  - `answer`: (String) 並び替え後の正しい文字列。

- **`type: "fill_in_the_blank_en"`** (英語穴埋め問題)
  - `answer`: (String) 穴埋め部分の正しい英単語。

- **`type: "numeric"`** (数値入力問題)
  - `answers`: (Array) ラベルと正解の数値を持つオブジェクトの配列。
    - `label`: (String) 入力フィールドのラベル（例: "x"）。
    - `answer`: (Integer/Float) 正解の数値。

- **`type: "svg_interactive"`** (SVGインタラクティブ問題)
  - `svg_content`: (String) 表示するSVG画像の文字列。
  - `sub_questions`: (Array) SVG内の各入力箇所に対応するサブ問題の配列。
    - `id`: (String) サブ問題の一意なID。
    - `prompt`: (String) 入力を促すプロンプト文。
    - `answer`: (String/Integer) その箇所の正解。
